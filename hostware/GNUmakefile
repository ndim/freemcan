# FIXME: Add proper dependencies for all those *.c and *.h files.

bin_PROGRAMS ?=

# Add call possible -I flags to ALL_CFLAGS later for include file
# dependeny detection
ALL_CFLAGS =

CFLAGS ?=
LDFLAGS ?=
LDLIBS ?=

CFLAGS += -std=c99
CFLAGS += -pedantic
CFLAGS += -Wall -Wextra
# CFLAGS += -Werror
CFLAGS += -g
CFLAGS += -I../include
CFLAGS += -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4

bin_PROGRAMS += querySerial
CLEANFILES   += querySerial


bin_PROGRAMS += freemcan-tui-poll
CLEANFILES   += freemcan-tui-poll

bin_PROGRAMS += freemcan-tui-select
CLEANFILES   += freemcan-tui-select

bin_PROGRAMS += freemcan-tui
CLEANFILES   += freemcan-tui

bin_PROGRAMS += test-log
CLEANFILES   += test-log

# Add to or override some variables here, if you want to
-include local.mk

.PHONY: all
all: depend $(bin_PROGRAMS)

DEPEND_MK = .depend.mk

.PHONY: ALL
ALL: all

.PHONY: clean
clean:
	rm -f $(CLEANFILES)
	rm -f $(DEPEND_MK)
	rm -f *.o

querySerial : querySerial.o serial-setup.o
	$(LINK.c) $^ $(LDLIBS) -o $@

freemcan-signals.o : CFLAGS += -D_GNU_SOURCE
freemcan-device.o : CFLAGS += -D_GNU_SOURCE
freemcan-tui.o : CFLAGS += -D_GNU_SOURCE
freemcan-tui-main-poll.o : CFLAGS += -D_GNU_SOURCE
freemcan-tui-main-select.o : CFLAGS += -D_GNU_SOURCE

-include $(DEPEND_MK)

HOST_SRC = checksum device export frame iohelpers log packet signals tui
HOST_OBJ = $(HOST_SRC:%=freemcan-%.o)

freemcan-tui-poll : freemcan-tui-main-poll.o serial-setup.o $(HOST_OBJ)
	$(LINK.c) $^ $(LDLIBS) -o $@

freemcan-tui-select : freemcan-tui-main-select.o serial-setup.o $(HOST_OBJ)
	$(LINK.c) $^ $(LDLIBS) -o $@

freemcan-tui : freemcan-tui-select
	rm -f "$@"
	ln "$<" "$@"

test-log : test-log.o freemcan-log.o
	$(LINK.c) $^ $(LDLIBS) -o $@

.PHONY: depend
depend: $(DEPEND_MK)

$(DEPEND_MK): $(wildcard *.c)
	echo '# DO NOT MODIFY THIS FILE -- it is autogenerated' > $(DEPEND_MK)
	echo '# You may delete this file, though (for the same reason).' >> $(DEPEND_MK)
	$(COMPILE.c) $(ALL_CFLAGS) -M $(wildcard *.c) >> $(DEPEND_MK)
