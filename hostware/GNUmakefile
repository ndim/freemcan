# Note: Run "make BUILD_FREEMCAN_GUI=yes" to build the GUI.

bin_PROGRAMS ?=
other_DATA ?=

CFLAGS ?=
LDFLAGS ?=
LDLIBS ?=

CFLAGS += -std=c99
CFLAGS += -pedantic
CFLAGS += -Wall -Wextra
# CFLAGS += -Werror
CFLAGS += -g
CFLAGS += -I../include
CFLAGS += -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4

bin_PROGRAMS += freemcan-tui-poll
CLEANFILES   += freemcan-tui-poll

bin_PROGRAMS += freemcan-tui-select
CLEANFILES   += freemcan-tui-select

bin_PROGRAMS += freemcan-tui
CLEANFILES   += freemcan-tui

ifeq ($(BUILD_FREEMCAN_GUI),yes)
bin_PROGRAMS += freemcan-gui
other_DATA   += freemcan-gui.ui
endif
CLEANFILES   += freemcan-gui
CLEANFILES   += freemcan-gui.ui

bin_PROGRAMS += test-log
CLEANFILES   += test-log

# Add to or override some variables here, if you want to
-include local.mk

.PHONY: all
all: depend $(bin_PROGRAMS) $(other_DATA)

DEPEND_MK = .depend.mk
DEPEND_MK_GUI = .depend-gui.mk

.PHONY: ALL
ALL: all

.PHONY: clean
clean:
	rm -f $(CLEANFILES)
	rm -f $(DEPEND_MK) $(DEPEND_MK_GUI)
	rm -f *.o


GUI_PACKAGES =
GUI_PACKAGES += glib-2.0
GUI_PACKAGES += cairo
GUI_PACKAGES += cairo-pdf
GUI_PACKAGES += cairo-png
GUI_PACKAGES += cairo-ps
GUI_PACKAGES += cairo-svg
GUI_PACKAGES += gconf-2.0
GUI_PACKAGES += gdk-2.0
GUI_PACKAGES += gtk+-2.0
GUI_PACKAGES += gmodule-2.0
GUI_CFLAGS = `pkg-config --cflags $(GUI_PACKAGES)`

freemcan-signals.o : CFLAGS += -D_GNU_SOURCE
freemcan-device.o : CFLAGS += -D_GNU_SOURCE
freemcan-tui.o : CFLAGS += -D_GNU_SOURCE
freemcan-tui-main-poll.o : CFLAGS += -D_GNU_SOURCE
freemcan-tui-main-select.o : CFLAGS += -D_GNU_SOURCE

fmainwindow.o : CFLAGS += -D_GNU_SOURCE
fmainwindow.o : CFLAGS += $(GUI_CFLAGS)
freemcan-gui-device.o : CFLAGS += $(GUI_CFLAGS)
freemcan-gui-diagram.o : CFLAGS += -D_GNU_SOURCE
freemcan-gui-diagram.o : CFLAGS += $(GUI_CFLAGS)
freemcan-gui-main.o : CFLAGS += -D_GNU_SOURCE
freemcan-gui-main.o : CFLAGS += $(GUI_CFLAGS)

-include $(DEPEND_MK)
-include $(DEPEND_MK_GUI)

TUI_COMMON_OBJ =
TUI_COMMON_OBJ += freemcan-checksum.o
TUI_COMMON_OBJ += freemcan-device.o
TUI_COMMON_OBJ += freemcan-export.o
TUI_COMMON_OBJ += freemcan-frame.o
TUI_COMMON_OBJ += freemcan-iohelpers.o
TUI_COMMON_OBJ += freemcan-log.o
TUI_COMMON_OBJ += freemcan-packet.o
TUI_COMMON_OBJ += freemcan-signals.o
TUI_COMMON_OBJ += freemcan-tui.o
TUI_COMMON_OBJ += serial-setup.o

freemcan-tui-poll : freemcan-tui-main-poll.o $(TUI_COMMON_OBJ) freemcan-device-poll.o
	$(LINK.c) $^ $(LDLIBS) -o $@

freemcan-tui-select : freemcan-tui-main-select.o $(TUI_COMMON_OBJ) freemcan-device-select.o
	$(LINK.c) $^ $(LDLIBS) -o $@

freemcan-tui : freemcan-tui-select
	rm -f "$@"
	ln "$<" "$@"

FGUI_OBJ =
FGUI_OBJ += fhistogram.o
FGUI_OBJ += fmainwindow.o
FGUI_OBJ += freemcan-gui-device.o
FGUI_OBJ += freemcan-gui-diagram.o
FGUI_OBJ += freemcan-gui-main.o
FGUI_OBJ += freemcan-checksum.o
FGUI_OBJ += freemcan-device.o
FGUI_OBJ += freemcan-export.o
FGUI_OBJ += freemcan-frame.o
FGUI_OBJ += freemcan-iohelpers.o
FGUI_OBJ += freemcan-log.o
FGUI_OBJ += freemcan-packet.o
FGUI_OBJ += serial-setup.o

freemcan-gui : LDLIBS += -lm
freemcan-gui : LDFLAGS += -Wl,--export-dynamic
freemcan-gui : LDLIBS += `pkg-config --libs $(GUI_PACKAGES)`
freemcan-gui : $(FGUI_OBJ)
	$(LINK.c) $^ $(LDLIBS) -o $@

lgpl-2.1.xml : ../lgpl-2.1.txt
	echo '<?xml version="1.0" encoding="us-ascii"?>' > $@
	echo -n '<text><![CDATA[' >> $@
	sed 's|||g' $< >> $@
	echo ']]></text>' >> $@

freemcan-gui.xml : freemcan-gui.glade
	gtk-builder-convert $< $@

freemcan-gui.ui : freemcan-gui.xml replace-license.xsl lgpl-2.1.xml
	xsltproc -o $@ replace-license.xsl $<

test-log : test-log.o freemcan-log.o
	$(LINK.c) $^ $(LDLIBS) -o $@

.PHONY: depend
depend : $(DEPEND_MK)

CSRC_GUI = $(wildcard freemcan-gui*.c) fmainwindow.c fhistogram.c
CSRC_NONGUI = $(filter-out $(CSRC_GUI), $(wildcard *.c))

$(DEPEND_MK): $(CSRC_NONGUI)
	echo '# DO NOT MODIFY THIS FILE -- it is autogenerated' > $@
	echo '# You may delete this file, though (for the same reason).' >> $@
	$(COMPILE.c) -M $(CSRC_NONGUI) >> $@

ifeq ($(BUILD_FREEMCAN_GUI),yes)
depend : $(DEPEND_MK_GUI)
$(DEPEND_MK_GUI): $(CSRC_GUI)
	echo '# DO NOT MODIFY THIS FILE -- it is autogenerated' > $@
	echo '# You may delete this file, though (for the same reason).' >> $@
	$(COMPILE.c) $(GUI_CFLAGS) -M $(CSRC_GUI) >> $@
endif
